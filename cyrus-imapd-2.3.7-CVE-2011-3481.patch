diff -up cyrus-imapd-2.3.16/imap/index.c.CVE-2011-3481 cyrus-imapd-2.3.16/imap/index.c
--- cyrus-imapd-2.3.16/imap/index.c.CVE-2011-3481	2009-12-02 03:18:12.000000000 +0100
+++ cyrus-imapd-2.3.16/imap/index.c	2011-09-30 16:30:04.800110766 +0200
@@ -193,6 +193,8 @@ static void index_thread_sort(Thread *ro
 static void index_thread_print(Thread *threads, int usinguid);
 static void index_thread_ref(unsigned *msgno_list, int nmsg, int usinguid);
 
+static void massage_header(char *hdr);
+
 /* NOTE: Make sure these are listed in CAPABILITY_STRING */
 static const struct thread_algorithm thread_algs[] = {
     { "ORDEREDSUBJECT", index_thread_orderedsubj },
@@ -4132,6 +4134,7 @@ void index_get_ids(MsgData *msgdata, cha
 	/* allocate some space for refs */
 	msgdata->ref = (char **) xmalloc(refsize * sizeof(char *));
 	/* find references */
+	massage_header(buf);
 	refstr = buf;
 	while ((ref = find_msgid(refstr, &refstr)) != NULL) {
 	    /* reallocate space for this msgid if necessary */
